#!/usr/bin/env bash

# Verify that assets with c8y_ExternalId have matching external IDs in the identity API

# import shared functions

# shellcheck source=/dev/null
source "$(dirname "$0")/../_shared/helper"
source "$(dirname "$0")/../_shared/constants"

# Stop on unexpected errors
set -e

help() {
    cat <<EOF
Verify external IDs for DTM assets

Usage:
  c8y dtm migration externalids-check [FLAGS]

Description:
  This command checks all DTM assets for different error conditions related to their c8y_ExternalId fragment and corresponding external IDs of type c8y_Asset in the Identity API.

Flags:
  -o, --output                  Output format of result. By default only errors are printed to stderr.
                                Set to "json" to output full results to stdout in json format.
  -e, --error-only              Output only assets with errors
  -s, --summary                 Show a summary of error counts in json format on stderr.
      --summary-only            Show only the summary of error counts in json format on stderr, no individual errors.
  -t, --id-template <template>  Template for generating the value of c8y_ExternalId assigned to the asset
                                Use for testing assets for placeholder fields required to generate the external ID.
                                Example: "dtm_{id}" or "dtm_{id}_{name}"
  -h, --help                    Show this help message
      --examples                Show usage examples

Errors:
  MissingExternalIdInAsset      Asset has no c8y_ExternalId, but has identity of type c8y_Asset
  MissingExternalIdAndIdentity  Asset has no c8y_ExternalId and no identity of type c8y_Asset
  MissingIdentityForAsset       Asset has c8y_ExternalId, but no identity of type c8y_Asset
  ExternalIdMismatch            Asset's c8y_ExternalId does not match external ID in Identity API
  MissingRequiredField          Asset is missing one or more required fields to generate c8y_ExternalId
  ExternalIdTemplateIdMismatch  Asset's c8y_ExternalId does not match expected value based on provided template
  TooManyIdentities             Asset has multiple identities of type c8y_Asset
  DuplicateExternalId           Assets that share the same c8y_ExternalId
  DuplicateTemplateId           Assets that have would have the same c8y_ExternalId based on the provided template

EOF
    exit 0
}

examples() {
    cat <<EOF
Examples:
  c8y dtm migration externalids-check --workers 10 --progress

  # check assets for errors, output to json, filter to only those missing c8y_ExternalId
  externalids-check --id-template "{field1}_{field2}" --workers 5 --output --error-only json 2> /dev/null | \
      c8y util show --select id,error --filter "nothas c8y_ExternalId"
EOF
    exit 0
}

POSITIONAL_ARGS=()
ERROR_ONLY=""
OUTPUT=""
SUMMARY=""
SUMMARY_ONLY=""

while [ $# -gt 0 ]; do
    case "$1" in
        -o|--output)
            OUTPUT="$2"
            shift
            ;;
        -t|--id-template)
            if [ -z "$2" ] || [[ "$2" =~ ^- ]]; then
                error "Argument --id-template requires a string value." "Use --help for details."
                exit 1
            fi
            ID_TEMPLATE="$2"
            shift
            ;;
        -e|--error-only)
            ERROR_ONLY="true"
            ;;
        -s|--summary)
            SUMMARY="true"
            ;;
        --summary-only)
            SUMMARY="true"
            SUMMARY_ONLY="true"
            ;;
        -h|--help)
            help
            ;;
        --examples)
            examples
            ;;
        *)
            POSITIONAL_ARGS+=("$1")
            ;;
    esac
    shift
done

set -- "${POSITIONAL_ARGS[@]}"

# Check if ID template is provided
if [ -z "$ID_TEMPLATE" ]; then
    error "The --id-template argument is required." "See 'c8y dtm migration externalids-create --help' for details."
    exit 1
fi

if [ "$OUTPUT" != "json" ] && [ "$OUTPUT" != "JSON" ]; then
    error "Invalid value for --output: $OUTPUT" "Supported values are: json"
    exit 1
fi

# List of allowed global/inherited flags for c8y identity list (short and long forms)
export ALLOWED_FLAGS=(
  --workers --progress --debug --cache --cacheBodyPaths --cacheTTL --delay --delayBefore --header -k --insecure -l --logMessage --maxJobs --noAccept -M --noColor --noCache --noLog --progress --timeout --workers --verbose
)

# Validate positional args 
validate_positional_args "$@"

# Fail if prerequisites are not met
check_prerequisites

# Validate and extract template properties
init_template_properties_array "$ID_TEMPLATE"

# if no properties extracted for a given template, this is an error
if [ "$ID_TEMPLATE" != "" ] && [ ${#TEMPLATE_PROPERTIES[@]} -eq 0 ]; then
    error "No properties found in ID template." "The template must include at least one placeholder to generate external IDs from."
    exit 1
fi

assets=$(load_all_assets)
total=$(echo "$assets" | wc -l | tr -d ' \n\r\t')

if [ -z "$assets" ] || [ "$total" -eq 0 ]; then
    info "No assets found for $C8Y_HOST. Exiting."
    exit 0
fi

info "Found $total assets. Checking external IDs..."

template_id_format=$(echo "$ID_TEMPLATE" | sed -E 's/\{([a-zA-Z0-9_.]+)\}/%\(\1\)s/g')

template_id_values=()
for prop in "${TEMPLATE_PROPERTIES[@]}"; do
    template_id_values+=("\"$prop\": std.get(input.value, \"$prop\", null)")
done
template_id_values_block=$(join ", " "${template_id_values[@]}")

template_id_condition=()
for prop in "${TEMPLATE_PROPERTIES[@]}"; do
    template_id_condition+=("std.get(input.value, \"$prop\", null) != null")
done
template_id_condition_block=$(join " && " "${template_id_condition[@]}")

output_template='
    local hasValue(obj, field) = std.objectHas(obj, field) && obj[field] != null && std.toString(obj[field]) != "";
    local template_id_values = {'"$template_id_values_block"'};
    local template_id = if '"$template_id_condition_block"' then "'"$template_id_format"'" % template_id_values else null;
    local common = { type: std.get(input.value, "type", null), template_id: template_id, tenant: "'"$C8Y_TENANT"'" };
    if output == null || (std.isArray(output) && std.length(output) == 0) then
        local err = if !hasValue(input.value, "c8y_ExternalId") then "MissingExternalIdAndIdentity" else "MissingIdentityForAsset";
        [input.value + common + { "error": err, externalId: null, c8y_ExternalId: std.get(input.value, "c8y_ExternalId", null) }]
    else
        local _out = if std.isArray(output) then output else [ output ];
        if std.length(_out) > 1 then
            [input.value + common + {
                "error": "TooManyIdentities", 
                externalId_type: std.get(_out[0], "type", null),
                template_id: std.get(input.value, "template_id", null),
                externalIds: [ obj.externalId for obj in _out if std.objectHas(obj, "externalId") ],
            }]
        else
            [input.value + common + {
                externalId: std.get(item, "externalId", null),
                externalId_type: std.get(item, "type", null),
                "error":
                    if hasValue(input.value, "error") then
                        std.get(input.value, "error", null)
                    else if template_id == null then
                        "MissingRequiredField"
                    else if !hasValue(input.value, "c8y_ExternalId") then
                        "MissingExternalIdInAsset"
                    else if !hasValue(item, "externalId") then
                        "MissingIdentityForAsset"
                    else if std.toString(item.externalId) != std.toString(input.value.c8y_ExternalId) then
                        "ExternalIdMismatch"
                    else if std.toString(input.value.c8y_ExternalId) != std.toString(template_id) then
                        "ExternalIdTemplateIdMismatch"
                    else
                        null
            } for item in _out]
'

result=$(echo "$assets" | c8y identity list \
    --output json \
    --outputTemplate "$output_template" \
    "${C8Y_FLAGS[@]}" 
)

duplicates=$(get_duplicate_external_ids "$result")

error_count=0
total_count=0

# Use process substitution to avoid subshell, so counters persist
while read -r id error error_msg; do
    if [ -z "$id" ]; then continue; fi

    if ! [ "$error" == "DuplicateTemplateId" ] && ! [ "$error" == "DuplicateExternalId" ]; then
        total_count=$((total_count+1))
    fi

    if ! [ -z "$error" ]; then
        error_count=$((error_count+1))
    else 
        continue
    fi

    if [ "$SUMMARY_ONLY" == "true" ]; then
        continue
    fi

    error "$id $error" "$error_msg"
done < <(cat <(echo "$result") <(echo "$duplicates") | jq -r '
    if .error == "MissingExternalIdInAsset" then
        "\(.id) MissingExternalIdInAsset asset has no c8y_ExternalId, but c8y_Asset identity with externalId \"\(.externalId)\""
    elif .error == "MissingExternalIdAndIdentity" then
        "\(.id) MissingExternalIdAndIdentity asset has no c8y_ExternalId and no c8y_Asset identity"
    elif .error == "MissingIdentityForAsset" then
        "\(.id) MissingIdentityForAsset asset has c8y_ExternalId \"\(.c8y_ExternalId)\", but no c8y_Asset identity"
    elif .error == "ExternalIdMismatch" then
        "\(.id) ExternalIdMismatch asset c8y_ExternalID \"\(.c8y_ExternalId)\" and c8y_Asset identity \"\(.externalId)\" do not match"
    elif .error == "MissingRequiredField" then
        "\(.id) MissingRequiredField asset is missing one or more required fields to generate c8y_ExternalId from template '"$ID_TEMPLATE"'"
    elif .error == "ExternalIdTemplateIdMismatch" then
        "\(.id) ExternalIdTemplateIdMismatch c8y_ExternalId \"\(.c8y_ExternalId)\" does not match expected value \"\(.template_id)\" from template '"$ID_TEMPLATE"'"
    elif .error == "DuplicateExternalId" then
        "\(.id) DuplicateExternalId asset shares c8y_ExternalId \"\(.c8y_ExternalId)\" with another asset"
    elif .error == "DuplicateTemplateId" then
        "\(.id) DuplicateTemplateId asset has same generated c8y_ExternalId \"\(.template_id)\" from template \"'"$ID_TEMPLATE"'\" as another asset"
    elif .error == "TooManyIdentities" then
        "\(.id) TooManyIdentities asset has more than one c8y_Asset identity \(.externalIds))"
    elif .error != "" and .error !=     null then
        "\(.id) \(.error) No error details available"
    else
        "\(.id)"
    end
')

if [ "$OUTPUT" == "json" ]; then
    if [ "$ERROR_ONLY" == "true" ]; then
        cat <(echo "$result" | jq -c '. | select(.error != null)') <(echo "$duplicates")
    else
        echo "$result"
    fi
fi

success "Completed checking all assets: $total_count total, $error_count errors."
if [ "$SUMMARY" == "true" ]; then
    summary=$(cat <(echo "$result") <(echo "$duplicates") | jq -s 'map(select(.error != null) | .error) | group_by(.) | map({(.[0]): length}) | add')
    info "$(echo "$summary" | jq .)"
fi
