#!/usr/bin/env bash

# Verify that assets with c8y_ExternalId have matching external IDs in the identity API

# import shared functions

# shellcheck source=/dev/null
source "$(dirname "$0")/../_shared/helper"
source "$(dirname "$0")/../_shared/constants"

# Stop on unexpected errors
set -e

help() {
    cat <<EOF
Verify external IDs for DTM assets

Usage:
    c8y dtm migration externalids-check [FLAGS]

Description:
    This command checks that all DTM assets with a c8y_ExternalId fragment have a corresponding external ID of type c8y_Asset in the identity API.

Flags:
        --output                  Output format of result. By default only errors are printed to stderr.
                                  Set to "json" to output full results to stdout in JSON format.
    -t, --id-template <template>  Template for generating the value of c8y_ExternalId assigned to the asset
                                  Use for testing assets for placeholder fields required to generate the external ID.
                                  Example: "dtm_{id}" or "dtm_{id}_{name}"
    -h, --help                    Show this help message
        --examples                Show usage examples

Errors:
    MissingExternalIdInAsset      Asset has no c8y_ExternalId, but has identity of type c8y_Asset
    MissingIdentityForAsset       Asset has c8y_ExternalId, but no identity of type c8y_Asset
    ExternalIdMismatch            Asset's c8y_ExternalId does not match external ID in Identity API
    MissingRequiredField          Asset is missing one or more required fields to generate c8y_ExternalId
    ExternalIdTemplateMismatch    Asset's c8y_ExternalId does not match expected value based on provided template

EOF
    exit 0
}

examples() {
    cat <<EOF
Examples:
    c8y dtm migration externalids-check --workers 10 --progress

    externalids-check --id-template "{field1}_{field2}" --workers 5 --output json 2> /dev/null | \
        c8y util show --select id,error
EOF
    exit 0
}

POSITIONAL_ARGS=()

while [ $# -gt 0 ]; do
    case "$1" in
        --output)
            OUTPUT="$2"
            shift
            ;;
        -t|--id-template)
            if [ -z "$2" ] || [[ "$2" =~ ^- ]]; then
                error "Argument --id-template requires a string value." "Use --help for details."
                exit 1
            fi
            ID_TEMPLATE="$2"
            shift
            ;;
        -h|--help)
            help
            ;;
        --examples)
            examples
            ;;
        *)
            POSITIONAL_ARGS+=("$1")
            ;;
    esac
    shift
done
set -- "${POSITIONAL_ARGS[@]}"

# List of allowed global/inherited flags for c8y identity list (short and long forms)
export ALLOWED_FLAGS=(
  --workers --progress --debug --delay --delayBefore --header -k --insecure -l --logMessage --maxJobs --noAccept -M --noColor --noCache --noLog --progress --timeout --workers --verbose
)

# Validate positional args 
validate_positional_args "$@"

# Fail if prerequisites are not met
check_prerequisites

# Validate and extract template properties
init_template_properties_array "$ID_TEMPLATE"

# if no properties extracted for a given template, this is an error
if [ "$ID_TEMPLATE" != "" ] && [ ${#TEMPLATE_PROPERTIES[@]} -eq 0 ]; then
    error "No properties found in ID template." "The template must include at least one placeholder to generate external IDs from."
    exit 1
fi

assets=$(load_all_assets)
total=$(echo "$assets" | jq -s 'length')

if [ "$total" -eq 0 ]; then
    info "No assets found for query ${FILTER_QUERY}. Exiting."
    exit 0
fi

info "Found $total assets. Checking external IDs..."

result=$(echo "$assets" | c8y identity list \
    --silentStatusCodes 404 \
    --silentExit \
    --withError \
    --output json \
    --outputTemplate '
      if std.objectHas(input.value, "error") then
        input.value
      else if !std.objectHas(input.value, "c8y_ExternalId") || std.toString(input.value.c8y_ExternalId) == "" then
        if std.length(output) > 0 then
          [item + input.value + { "error": "MissingExternalIdInAsset" } for item in output]
        else
          [output + {type: "", externalId: "", "error": "MissingExternalIdInAsset"}]
      else if std.length(output) > 0 then
        [input.value + {
          type: if std.objectHas(item, "type") then std.toString(item.type) else "",
          externalId: if std.objectHas(item, "externalId") then std.toString(item.externalId) else "",
          "error": if std.objectHas(item, "externalId") then
                      if std.toString(item.externalId) != input.value.c8y_ExternalId then "ExternalIdMismatch" else ""
                   else ""
        } for item in output]
      else
        [input.value + {type: "", externalId: "", "error": "MissingIdentityForAsset"}]
    ' \
    "${C8Y_FLAGS[@]}" 
)

error_count=0
total_count=0

# Use process substitution to avoid subshell, so counters persist
while read -r id error error_msg; do
    if [ -z "$id" ]; then continue; fi

    if ! [ -z "$error" ]; then
        error_count=$((error_count+1))
    fi

    total_count=$((total_count+1))
    error "$id $error" "$error_msg"
done < <(echo "$result" | jq -r '
    if .error == "MissingExternalIdInAsset" then
        "\(.id) MissingExternalIdInAsset asset has no c8y_ExternalId, but has \"\(.externalId)\" identity of type c8y_Asset"
    elif .error == "MissingIdentityForAsset" then
        "\(.id) MissingIdentityForAsset expected \"\(.c8y_ExternalId)\" of type c8y_Asset"
    elif .error == "ExternalIdMismatch" then
        "\(.id) ExternalIdMismatch expected \"\(.c8y_ExternalId)\", got \"\(.externalId)\""
    elif .error == "MissingRequiredField" then
        "\(.id) MissingRequiredField missing one or more required fields to generate c8y_ExternalId"
    elif .error == "ExternalIdTemplateMismatch" then
        "\(.id) ExternalIdTemplateMismatch c8y_ExternalId \"\(.c8y_ExternalId)\" does not match expected \"\(.external_id)\""
    elif .error != "" and .error != null then
        "\(.id) \(.error) No error details available"
    else
        "\(.id)"
    end
')

if [ "$OUTPUT" == "json" ]; then
    echo "$result" 
fi

success "Completed checking all assets: $total_count total, $error_count errors."