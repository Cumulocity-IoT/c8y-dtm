#!/usr/bin/env bash

# Create external IDs for DTM assets based on template with parallel processing

# import shared functions

# shellcheck source=/dev/null
source "$(dirname "$0")/../_shared/helper"
source "$(dirname "$0")/../_shared/constants"

# Stop on unexpected errors
set -e

# Help text
help() {
    cat <<EOF
Create external IDs for DTM assets to be used with upserting assets.

Usage:
  c8y dtm migration externalids-create [FLAGS]

Description:
  This command creates external IDs for DTM assets using a configurable template. All assets or 
  all assets matching a given query will be updated with a  c8y_ExternalId fragment generated 
  based on the provided template. The template can include placeholders for any asset fragment or
  property. 
    
  For the c8y_ExternalId, an external id of type c8y_Asset will be created in the Identity API.

  Using the --external-asset flag, a c8y_ExternalAsset fragment can also be added to the asset 
  with an optional JSON object as its value. If no value is provided, the fragment will be 
  created with an empty object. If null is provided, the fragment will be deleted.

Flags:
  -o, --output                 Output format of result. By default only errors are printed to stderr.
                               Set to "json" to output full results to stdout in JSON format.
  -t, --id-template <template> Template for generating the value of c8y_ExternalId from asset (required)
                               Supports placeholders for any asset fragment or property.
  -e, --external-asset <json>  Assign c8y_ExternalAsset. Value is fragment value as JSON.
                               If no value is provided, an empty object will be assigned.
                               If null is provided, the fragment will be deleted.
  -u, --use-asset-upsert       Use asset upsert to create external IDs (default: false).
  -f, --filter <query>         Query to filter assets (e.g., "type eq 'MyAssetType'").
                               default: "not(has(${EXTERNAL_ID_FRAGMENT}))"
  -h, --help                   Show this help message.
      --examples               Show usage examples.

Template Placeholders:
  {<fragment>}               Any fragment (e.g., {name} or {id})
  {<fragment>.<property>}    Any fragment property (e.g., {c8y_IsDevice.name})
    
  Note: Template placeholders can reference any fragment or property available
  in the asset's JSON structure. Use dot notation for nested properties.

Requirements:
  - go-c8y-cli authenticated session (dev mode)
  - jq for JSON processing

EOF

exit 0
}

examples () {
  cat <<EOF
Examples:
  # Create external IDs with simple ID template
  c8y dtm migration externalids-create --id-template "dtm_{id}" --external-asset '{"source": "Acme Inc."}'
    
  # Use asset name and type fragments
  c8y dtm migration externalids-create --id-template "asset_{name}_{type}" --workers 8

  # Complex template with multiple fragments
  c8y dtm migration externalids-create --id-template "{owner}_{fragment.name}_{id}"

  # Use external asset JSON data
  c8y dtm migration externalids-create --id-template "ext_{id}" --external-asset '{"source": "Acme Inc."}'

  # Check assets have properties used in template and no external IDs yet
  c8y inventory find --fragmentType "c8y_IsAsset" --select id,name,fragment1,fragment2,c8y_ExternalId --pageSize 1

  # Check relevant fragments after creation
  c8y inventory find --query "has(c8y_ExternalId)" --fragmentType "c8y_IsAsset" --select id,c8y_ExternalId,c8y_ExternalAsset
    
  # Check identity has been created correctly
  c8y inventory find --fragmentType "c8y_IsAsset" --pageSize 1 | c8y identity list --filter 'type eq c8y_Asset' 

EOF

exit 0
}

ALLOWED_FLAGS=(
  --cache --cacheBodyPaths --cacheTTL --debug --delay --delayBefore --header -k --insecure -l --logMessage --maxJobs --noAccept -M --noColor --noCache --progress --timeout --totalErrors --workers --verbose
)

ID_TEMPLATE=""
EXTERNAL_ASSET=""
FILTER_QUERY="not(has(${EXTERNAL_ID_FRAGMENT}))"
USE_ASSET_UPSERT=0
POSITIONAL_ARGS=()
OUTPUT=""

# Parse Flags: --flag <value>, or boolean/switch flags: --help|-h
while [ $# -gt 0 ]; do
    case "$1" in
        # Flag which expects an argument
        -t|--id-template)
            if [ -z "$2" ] || [[ "$2" =~ ^- ]]; then
                error "--id-template requires a template string argument." "Use --help for details."
                exit 1
            fi
            ID_TEMPLATE="$2"
            shift
            ;;
        -e|--external-asset)
            if [ -z "$2" ] || [[ "$2" =~ ^- ]]; then
                EXTERNAL_ASSET="{}"
            else
                EXTERNAL_ASSET="$2"
                shift
            fi
            ;;
        -o|--output)
            OUTPUT="$2"
            shift
            ;;
        -f|--filter)
            if [[ "$2" =~ ^- ]]; then
                error "--filter requires a query string argument." "Use --filter \"\" to query without any filter."
                exit 1
            fi
            FILTER_QUERY="$2"
            shift
            ;;
        -u|--use-asset-upsert)
            USE_ASSET_UPSERT=1
            ;;
        # Support showing help
        -h|--help)
            help
            ;;
        --examples)
            examples
            ;;
        # Save positional arguments
        *)
            POSITIONAL_ARGS+=("$1")
            ;;
    esac
    shift
done

# Restore additional arguments
set -- "${POSITIONAL_ARGS[@]}"

# Check if ID template is provided
if [ -z "$ID_TEMPLATE" ]; then
    error "The --id-template argument is required." "See 'c8y dtm migration externalids-create --help' for details."
    exit 1
fi

# Validate external asset JSON format
if ! echo "$EXTERNAL_ASSET" | jq empty; then
    error "Invalid JSON for --external-asset: $EXTERNAL_ASSET" "Use '{}', '{\"source\": \"Acme Inc.\"}', or null."
    exit 1
fi

## Validate arguments
validate_positional_args "$@"

check_prerequisites

# Validate and extract template properties
init_template_properties_array "$ID_TEMPLATE"

# if no properties extracted, warn user
if [ ${#TEMPLATE_PROPERTIES[@]} -eq 0 ]; then
    error "No properties found in ID template. The template must include at least one placeholder to generate external IDs from."
    exit 1
fi

process_assets() {
    local total_processed=0

    local start_time end_time elapsed
    start_time=$(date +%s)

    output_template='[ input.value + {
        "'"$EXTERNAL_ASSET_FRAGMENT"'": std.get(output, "'"$EXTERNAL_ASSET_FRAGMENT"'", std.get(input.value, "'"$EXTERNAL_ASSET_FRAGMENT"'", null)),
        "externalId": if std.objectHas(output, "managedObject") then output else null,
    }]'

    # Create input template for updating assets, used in both inventory update and asset upsert body
    template_fields=(
        "${EXTERNAL_ID_FRAGMENT}: input.value.template_id"
    )
    if [ ! -z "$EXTERNAL_ASSET" ]; then
        template_fields+=(
            "${EXTERNAL_ASSET_FRAGMENT}: ${EXTERNAL_ASSET}"
        )
    fi
    input_template="{ $(join ', ' "${template_fields[@]}") }"
    local result=""
    if [ "$USE_ASSET_UPSERT" = "1" ]; then
        info "Using asset upsert for creating external ID..."
        result=$(echo "$all_assets" | \
            c8y dtm assets update \
                --assetId "{id}" \
                --template "$input_template" \
                --outputTemplate "$output_template" \
                --force \
                "${C8Y_FLAGS[@]}"
        )
    else
        info "Using inventory update for creating external ID..."
        result=$(echo "$all_assets" | \
           c8y inventory update \
                --template "$input_template" \
                --outputTemplate "$output_template" \
                --force \
                "${C8Y_FLAGS[@]}"
        )

        info "Creating identities for assets of type c8y_Asset..."
        result=$(echo "$result" | \
            c8y identity create \
                --type "c8y_Asset" \
                --template '{ device: input.value.id, externalId: input.value.template_id }' \
                --outputTemplate "$output_template" \
                --force \
                "${C8Y_FLAGS[@]}"
        )
    fi

    total_processed=$(echo "$all_assets" | wc -l | tr -d ' \n\r\t')
    end_time=$(date +%s)
    elapsed=$((end_time - start_time))

    if [ "$OUTPUT" == "json" ]; then
        echo "$result"
    fi    

    success "Processed $total_processed assets for $C8Y_TENANT (${elapsed}s)"

    return 0
}

all_assets=""
if [ ! -t 0 ]; then
    all_assets=$(cat)
else
    all_assets=$(load_all_assets)
fi

if is_empty_result_set "$all_assets" ; then
    info "No assets to process. Exiting."
    exit 0
fi

total_collected=$(count_lines "$all_assets")
info "Processing $total_collected assets..."

# check for errors and fail if errors found
assets_with_errors=$(echo "$all_assets" | jq -c 'select(.error == "MissingRequiredField")')
error_count=$(echo "$assets_with_errors" | jq -s 'length')

if [ "$error_count" -gt 0 ]; then
    error "Found $error_count assets with missing required fields for generating external IDs."
fi

duplicates=$(get_duplicate_external_ids "$all_assets" )
duplicate_count=$(echo "$duplicates" | jq -s 'length')
if [ -n "$duplicates" ]; then
    error "Found duplicate generated external IDs. Can not create unique external IDs with the provided template."
fi

if ! [ "$error_count" -eq 0 ] || ! [ "$duplicate_count" -eq 0 ]; then
    error "Aborting due to errors in asset data. Please fix the issues and try again."
    cat <(echo "$assets_with_errors") <(echo "$duplicates")

    exit 1
fi

process_assets

# Export function and variables for parallel processing
export -f process_assets 
export ID_TEMPLATE EXTERNAL_ASSET EXTERNAL_ID_FRAGMENT FILTER_QUERY ALLOWED_FLAGS 
